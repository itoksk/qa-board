<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let currentQuestions = [];

// Google Apps Scripté–¢æ•°ã®å‘¼ã³å‡ºã—
const GAS = {
    submitQuestion: (data) => {
        return new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .submitQuestion(data);
        });
    },
    getQuestions: (region) => {
        return new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .getQuestions(region);
        });
    },
    getGeneratedQuestions: (region) => {
        return new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .getGeneratedQuestions(region);
        });
    },
    generateRepresentative: (region, password, forceRegenerate) => {
        return new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .generateRepresentative(region, password, forceRegenerate);
        });
    },
    addLike: (questionId) => {
        return new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .addLike(questionId);
        });
    }
};

// ç”»é¢è¡¨ç¤ºåˆ¶å¾¡
function showQuestionForm() {
    hideAllSections();
    document.getElementById('questionForm').classList.remove('hidden');
}

function showQuestions() {
    hideAllSections();
    document.getElementById('questionList').classList.remove('hidden');
    loadQuestions();
}

function showGeneratedQuestions() {
    hideAllSections();
    document.getElementById('generatedQuestions').classList.remove('hidden');
    loadGeneratedQuestions();
}

function showAdminSection() {
    hideAllSections();
    document.getElementById('adminSection').classList.remove('hidden');
}

function hideAllSections() {
    document.getElementById('questionForm').classList.add('hidden');
    document.getElementById('questionList').classList.add('hidden');
    document.getElementById('generatedQuestions').classList.add('hidden');
    document.getElementById('adminSection').classList.add('hidden');
}

// è³ªå•æŠ•ç¨¿
async function submitQuestionForm(event) {
    event.preventDefault();
    
    const button = document.getElementById('submitButton');
    const originalText = button.textContent;
    button.disabled = true;
    button.innerHTML = '<div class="loader inline-block w-5 h-5 mr-2"></div>é€ä¿¡ä¸­...';
    
    const formData = {
        region: event.target.region.value,
        category: event.target.category.value,
        content: event.target.content.value,
        author: event.target.author.value || 'åŒ¿å'
    };
    
    try {
        const result = await GAS.submitQuestion(formData);
        if (result.success) {
            showNotification('è³ªå•ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ');
            event.target.reset();
            // è³ªå•ä¸€è¦§ç”»é¢ã«é·ç§»
            setTimeout(() => {
                showQuestions();
            }, 1000);
        } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
        }
    } catch (error) {
        console.error('æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
    } finally {
        button.disabled = false;
        button.textContent = originalText;
    }
}

// è³ªå•ä¸€è¦§èª­ã¿è¾¼ã¿
async function loadQuestions() {
    const container = document.getElementById('questionsContainer');
    const region = document.getElementById('regionFilter').value;
    
    container.innerHTML = '<div class="text-center py-8"><div class="loader"></div><p class="mt-4 text-gray-400">è³ªå•ã‚’èª­ã¿è¾¼ã¿ä¸­...</p></div>';
    
    try {
        const result = await GAS.getQuestions(region);
        console.log('è³ªå•å–å¾—çµæœ:', result);
        
        if (result.success) {
            currentQuestions = result.questions;
            displayQuestions(result.questions);
        } else {
            container.innerHTML = '<p class="text-center text-red-400">ã‚¨ãƒ©ãƒ¼: ' + result.error + '</p>';
        }
    } catch (error) {
        console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        container.innerHTML = '<p class="text-center text-red-400">é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + error + '</p>';
    }
}

// è³ªå•è¡¨ç¤º
function displayQuestions(questions) {
    const container = document.getElementById('questionsContainer');
    
    if (!questions || questions.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-400 py-8">ã¾ã è³ªå•ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
    }
    
    // HTMLã‚’æ§‹ç¯‰
    const html = questions.map(q => {
        const questionId = q.id || '';
        const category = q.category || '';
        const region = q.region || '';
        const content = q.content || '';
        const author = q.author || 'åŒ¿å';
        const timestamp = q.timestamp || new Date().toISOString();
        const likes = q.likes || 0;
        const processed = q.processed || false;
        
        return createQuestionCard(questionId, category, region, content, author, timestamp, likes, processed);
    }).join('');
    
    container.innerHTML = html;
}

// è³ªå•ã‚«ãƒ¼ãƒ‰ã®HTMLç”Ÿæˆ
function createQuestionCard(id, category, region, content, author, timestamp, likes, processed) {
    const isLiked = localStorage.getItem(`liked_${id}`) === 'true';
    return `
        <div class="glass-effect rounded-xl p-6 hover:shadow-xl transition-shadow">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <span class="inline-block px-3 py-1 bg-purple-600/20 text-purple-400 rounded-full text-sm font-medium">
                        ${getCategoryLabel(category)}
                    </span>
                    <span class="inline-block px-3 py-1 bg-blue-600/20 text-blue-400 rounded-full text-sm font-medium ml-2">
                        ${getRegionLabel(region)}
                    </span>
                    ${processed ? '<span class="inline-block px-3 py-1 bg-green-600/20 text-green-400 rounded-full text-sm font-medium ml-2">å‡¦ç†æ¸ˆã¿</span>' : ''}
                </div>
                <span class="text-gray-400 text-sm">${formatDate(timestamp)}</span>
            </div>
            <p class="text-lg mb-2">${escapeHtml(content)}</p>
            <div class="flex justify-between items-center">
                <p class="text-gray-400 text-sm">æŠ•ç¨¿è€…: ${escapeHtml(author)}</p>
                <button 
                    onclick="handleLike('${id}')" 
                    id="like-btn-${id}"
                    class="like-button ${isLiked ? 'liked' : ''}"
                >
                    <span class="like-emoji">${isLiked ? 'â¤ï¸' : 'ğŸ‘'}</span>
                    <span id="like-count-${id}" class="font-medium">${likes || 0}</span>
                </button>
            </div>
        </div>
    `;
}

// ä»£è¡¨è³ªå•èª­ã¿è¾¼ã¿
async function loadGeneratedQuestions() {
    const container = document.getElementById('generatedQuestionsContainer');
    const region = document.getElementById('generatedRegionFilter').value;
    
    container.innerHTML = '<div class="text-center py-8"><div class="loader"></div><p class="mt-4 text-gray-400">ä»£è¡¨è³ªå•ã‚’èª­ã¿è¾¼ã¿ä¸­...</p></div>';
    
    try {
        const result = await GAS.getGeneratedQuestions(region);
        if (result.success) {
            displayGeneratedQuestions(result.representatives);
        } else {
            container.innerHTML = '<p class="text-center text-red-400">ã‚¨ãƒ©ãƒ¼: ' + result.error + '</p>';
        }
    } catch (error) {
        container.innerHTML = '<p class="text-center text-red-400">é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + error + '</p>';
    }
}

// ä»£è¡¨è³ªå•è¡¨ç¤º
function displayGeneratedQuestions(representatives) {
    const container = document.getElementById('generatedQuestionsContainer');
    
    if (!representatives || representatives.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-400 py-8">ã¾ã ä»£è¡¨è³ªå•ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
        return;
    }
    
    // æœ€çµ‚æ›´æ–°æ—¥æ™‚ã‚’è¡¨ç¤º
    if (representatives.length > 0) {
        const lastUpdated = document.getElementById('lastUpdated');
        lastUpdated.textContent = 'æœ€çµ‚æ›´æ–°: ' + formatDate(representatives[0].generatedAt);
    }
    
    const html = representatives.map(rep => createRepresentativeCard(rep)).join('');
    container.innerHTML = html;
}

// ä»£è¡¨è³ªå•ã‚«ãƒ¼ãƒ‰ã®HTMLç”Ÿæˆ
function createRepresentativeCard(rep) {
    const sourceQuestions = rep.sourceQuestions || [];
    
    return `
        <div class="glass-effect rounded-xl p-6">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <span class="inline-block px-3 py-1 bg-purple-600/20 text-purple-400 rounded-full text-sm font-medium">
                        ${getCategoryLabel(rep.category)}
                    </span>
                    <span class="inline-block px-3 py-1 bg-blue-600/20 text-blue-400 rounded-full text-sm font-medium ml-2">
                        ${getRegionLabel(rep.region)}
                    </span>
                </div>
                <span class="text-gray-400 text-sm">${formatDate(rep.generatedAt)} ç”Ÿæˆ</span>
            </div>
            <h4 class="text-xl font-semibold mb-3">${escapeHtml(rep.question)}</h4>
            <p class="text-gray-300 mb-4">ã“ã®ä»£è¡¨è³ªå•ã¯ã€${rep.clusterSize}ä»¶ã®é¡ä¼¼è³ªå•ã‹ã‚‰ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚</p>
            ${sourceQuestions.length > 0 ? `
            <details class="text-sm">
                <summary class="cursor-pointer text-purple-400 hover:text-purple-300">å…ƒã®è³ªå•ã‚’è¡¨ç¤º</summary>
                <ul class="mt-2 space-y-2 text-gray-400">
                    ${sourceQuestions.map(q => `<li>â€¢ ${escapeHtml(q)}</li>`).join('')}
                </ul>
            </details>
            ` : ''}
        </div>
    `;
}

// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼
function showPasswordPrompt() {
    document.getElementById('passwordModal').classList.remove('hidden');
    document.getElementById('passwordInput').value = '';
    document.getElementById('passwordError').classList.add('hidden');
    document.getElementById('passwordInput').focus();
}

function closePasswordModal() {
    document.getElementById('passwordModal').classList.add('hidden');
}

async function checkPassword() {
    const password = document.getElementById('passwordInput').value;
    if (password === 'ictedu') {
        closePasswordModal();
        showAdminSection();
    } else {
        document.getElementById('passwordError').classList.remove('hidden');
    }
}

// ä»£è¡¨è³ªå•ç”Ÿæˆ
async function generateRepresentativeQuestions() {
    const button = document.getElementById('generateButton');
    const originalText = button.textContent;
    button.disabled = true;
    button.innerHTML = '<div class="loader inline-block w-5 h-5 mr-2"></div>ç”Ÿæˆä¸­...';
    
    const region = document.getElementById('adminRegion').value;
    const forceRegenerate = document.getElementById('forceRegenerate').checked;
    
    try {
        const result = await GAS.generateRepresentative(region, 'ictedu', forceRegenerate);
        const resultsDiv = document.getElementById('generationResults');
        
        if (result.success) {
            resultsDiv.innerHTML = `
                <p class="text-green-400 mb-2">ç”Ÿæˆå®Œäº†ã—ã¾ã—ãŸ</p>
                <p class="text-gray-300">å¯¾è±¡åœ°åŸŸ: ${getRegionLabel(region)}</p>
                <p class="text-gray-300">å‡¦ç†ã—ãŸè³ªå•æ•°: ${result.results.processedCount}</p>
                <p class="text-gray-300">ç”Ÿæˆã—ãŸä»£è¡¨è³ªå•æ•°: ${result.results.representativeCount}</p>
                ${result.results.message ? `<p class="text-gray-300 mt-2">${result.results.message}</p>` : ''}
            `;
            showNotification('ä»£è¡¨è³ªå•ã®ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ');
        } else {
            resultsDiv.innerHTML = `<p class="text-red-400">ã‚¨ãƒ©ãƒ¼: ${result.error}</p>`;
        }
    } catch (error) {
        document.getElementById('generationResults').innerHTML = 
            `<p class="text-red-400">é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error}</p>`;
    } finally {
        button.disabled = false;
        button.textContent = originalText;
    }
}

// ã„ã„ã­å‡¦ç†
async function handleLike(questionId) {
    console.log('ã„ã„ã­ã‚¯ãƒªãƒƒã‚¯:', questionId);
    
    const button = document.getElementById(`like-btn-${questionId}`);
    const countSpan = document.getElementById(`like-count-${questionId}`);
    const isLiked = localStorage.getItem(`liked_${questionId}`) === 'true';
    
    if (!button || !countSpan) {
        console.error('è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }
    
    // æ—¢ã«ã„ã„ã­æ¸ˆã¿ã®å ´åˆ
    if (isLiked) {
        showNotification('æ—¢ã«ã„ã„ã­ã—ã¦ã„ã¾ã™ â¤ï¸', 'info');
        button.classList.add('shake-animation');
        setTimeout(() => button.classList.remove('shake-animation'), 600);
        return;
    }
    
    // ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
    button.disabled = true;
    button.classList.add('opacity-50', 'cursor-not-allowed', 'liking');
    
    try {
        const result = await GAS.addLike(questionId);
        
        if (result.success) {
            // ã„ã„ã­æ•°ã‚’æ›´æ–°
            countSpan.textContent = result.newLikeCount;
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            localStorage.setItem(`liked_${questionId}`, 'true');
            button.classList.add('liked');
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
            button.classList.add('like-animation');
            setTimeout(() => {
                button.classList.remove('like-animation');
            }, 600);
            
            // çµµæ–‡å­—ã‚’æ›´æ–°
            const emojiSpan = button.querySelector('.like-emoji');
            if (emojiSpan) {
                emojiSpan.textContent = 'â¤ï¸';
            }
            
            showNotification('ã„ã„ã­ã—ã¾ã—ãŸï¼â¤ï¸', 'success');
        } else {
            showNotification('ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('ã„ã„ã­ã‚¨ãƒ©ãƒ¼:', error);
        showNotification('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    } finally {
        // ãƒœã‚¿ãƒ³ã‚’å†åº¦æœ‰åŠ¹åŒ–
        setTimeout(() => {
            button.disabled = false;
            button.classList.remove('opacity-50', 'cursor-not-allowed', 'liking');
        }, 1000);
    }
}

// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
function getCategoryLabel(category) {
    const labels = {
        'ai': 'ç”ŸæˆAI',
        'education': 'æ•™è‚²',
        'ict': 'ICT',
        'other': 'ãã®ä»–'
    };
    return labels[category] || category;
}

function getRegionLabel(region) {
    const labels = {
        'osaka': 'å¤§é˜ª',
        'nagoya': 'åå¤å±‹',
        'fukuoka': 'ç¦å²¡',
        'hiroshima': 'åºƒå³¶',
        'tokyo': 'æ±äº¬',
        'all': 'å…¨åœ°åŸŸ'
    };
    return labels[region] || region;
}

function formatDate(dateString) {
    if (!dateString) return '';
    
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    
    if (diff < 60000) return 'ä»Š';
    if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†å‰';
    if (diff < 86400000) return Math.floor(diff / 3600000) + 'æ™‚é–“å‰';
    
    return date.toLocaleDateString('ja-JP') + ' ' + 
           date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showNotification(message) {
    const notification = document.getElementById('successNotification');
    const messageEl = document.getElementById('successMessage');
    
    messageEl.textContent = message;
    notification.classList.remove('hidden');
    notification.classList.remove('translate-x-full');
    
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            notification.classList.add('hidden');
        }, 300);
    }, 3000);
}

// Enterã‚­ãƒ¼ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼
document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.getElementById('passwordInput');
    if (passwordInput) {
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });
    }
});
</script>